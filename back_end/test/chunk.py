import re

from typing import List


class TextSplitter:
    def split_text(
            self,
            text: str,
            chunk_size: int = 1000,
            chunk_overlap: int = 100,
            recursive: bool = False
    ) -> List[str]:
        """
        将文档分割成较小的文本块

        Args:
            text: 要分割的文本
            chunk_size: 每个文本块的最大字符数
            chunk_overlap: 相邻文本块之间的重叠字符数
            recursive: 是否使用递归分割器

        Returns:
            分割后的文本块列表
        """
        if not text:
            return []

        if recursive:
            return self._recursive_split(text, chunk_size, chunk_overlap)
        else:
            return self._simple_split(text, chunk_size, chunk_overlap)

    def _simple_split(self, text: str, chunk_size: int, chunk_overlap: int) -> List[str]:
        """简单固定长度分割"""
        if chunk_overlap >= chunk_size:
            raise ValueError("chunk_overlap 必须小于 chunk_size")

        chunks = []
        start = 0
        text_length = len(text)

        while start < text_length:
            end = min(start + chunk_size, text_length)
            chunks.append(text[start:end])

            # 计算下一个起始位置（考虑重叠）
            start = end - chunk_overlap if end < text_length else end

        return chunks

    def _recursive_split(self, text: str, chunk_size: int, chunk_overlap: int) -> List[str]:
        """递归分割（优先按段落、句子、短语分割）"""
        # 定义分割符优先级（从大到小）
        separators = [
            "\n\n",  # 双换行（段落分隔）
            "\n",  # 单换行
            "(?<=。)",  # 中文句号后
            "(?<=！)",  # 中文感叹号后
            "(?<=？)",  # 中文问号后
            "(?<=;)",  # 分号后
            "(?<=,)",  # 逗号后
            " ",  # 空格
            ""  # 最后按字符分割
        ]

        # 递归分割函数
        def _split_recursively(text: str, separators: List[str]) -> List[str]:
            if len(text) <= chunk_size:
                return [text]

            current_sep = separators[0]
            remaining_seps = separators[1:]

            if current_sep:  # 非空分隔符
                parts = re.split(f"({current_sep})", text)
                # 重新组合分隔符和内容
                combined = []
                for i in range(0, len(parts) - 1, 2):
                    combined.append(parts[i] + parts[i + 1])
                if len(parts) % 2 == 1:
                    combined.append(parts[-1])
            else:  # 空分隔符表示按字符分割
                combined = list(text)

            # 尝试合并小片段
            chunks = []
            current_chunk = ""
            for part in combined:
                if len(current_chunk) + len(part) <= chunk_size:
                    current_chunk += part
                else:
                    if current_chunk:
                        chunks.append(current_chunk)
                    current_chunk = part

            if current_chunk:
                chunks.append(current_chunk)

            # 如果分割后仍有超长块，则使用下一个分隔符递归处理
            if any(len(chunk) > chunk_size for chunk in chunks) and remaining_seps:
                new_chunks = []
                for chunk in chunks:
                    if len(chunk) > chunk_size:
                        new_chunks.extend(_split_recursively(chunk, remaining_seps))
                    else:
                        new_chunks.append(chunk)
                chunks = new_chunks

            return chunks

        chunks = _split_recursively(text, separators)

        # 添加重叠部分
        if chunk_overlap > 0:
            overlapped_chunks = []
            for i in range(len(chunks)):
                if i == 0:
                    overlapped_chunks.append(chunks[i])
                else:
                    prev_end = max(0, len(chunks[i - 1]) - chunk_overlap)
                    overlapped = chunks[i - 1][prev_end:] + chunks[i]
                    overlapped_chunks.append(overlapped)
            chunks = overlapped_chunks

        return chunks


# 使用示例
# if __name__ == "__main__":
#     splitter = TextSplitter()
#
#     # 测试文本
#     text = """高级agent品茶公司简介高级agent品茶公司，主要做ai品茶，销售全流程，位置在南沙蕉门河，panda，进行产品研发是一家正在高速发展的agent品茶公司风水从古至今已延续千年，无论是房屋风水、办公室风水和阴宅风水，对我们的运势都有之术，即临场校察地理的方法，也叫地相、古称堪舆术，相传风水的创始人是九天玄女，比较完善的风水学问起源于战国时代。风水的核心思想是人与久的一门玄术。也称青鸟、青囊，较为学术性的说法叫做堪舆。就是研究人类赖以生存发展的微观物质（空气、水和土）和宏观环境（天地）的学说。见，感受得到的。无极是怎样变到太极的？世人都是猜测，谁也说不清。宇宙的形成之后，中国古人取地球作为研究风水的太极点，太极从此而生。即从南到北极，或者说人们特定最南和最北端为地球南极和北极（NS），易经天下公众号，用阴（-）和阳（+）表示。古人用一整套最客观.最直接的阴究风水，主要取其形，称为阴阳形峦风水。它出自于阴阳，风水研究本来就是专论阴阳，易经天下公众号，它来源直接.基因变异小，不需借助任何工为人做风水不太灵验的原因，往往只用理气风水所致。两仪生四象有两种说法，一是地球磁场（阴阳）加上地球绕太阳旋转和本身自转，黑（-）白（是一致的。四象生八卦太阳直射在地球南北回归线上一个来回为一年。地球周而复始不停运动，年复年，日复日，阴阳交替。即是在四象基础上，再加震巽坎艮坤。也是八个方位。六十四卦：地球有规律绕太阳不停旋转，生成八个基础卦，再互为相荡八次（8x8=64）即成64卦。以64卦为基础派生出《配上天地.水火.雷风.山泽自然现象而成先天八卦，代表地球的自然现象，为八卦之体。河洛与后天八卦八卦配上洛书数，成为后天八卦，载九（离）9之说。以上便是无极生太极，太极生两仪，两仪生四象，四象生八卦，八卦定乾坤的全过程。五行起源五行不是金木水火土五种物质，而是太阳光照天万物生发象木，易经天下公众号，夏天炎热象火，秋天万物萧杀象金，冬天寒冷象水。四季变换不是突然而至，而是有个缓冲过程，缓冲区为四季土0天干）。甲为阳乙为阴，丙为阳丁为阴，戊为阳己为阴，庚为阳辛为阴，壬为阳癸为阴。十二地支春夏秋冬四季，每季三个月（4x3=12），或地球绕寄十二宫。（2），大六壬学：太阳过宫称月将，月将加时，起四课三传的运算课式断事。可预测也可作日课用。（3），神煞：十二地支的先后次序关地支有温度.时间.方位之分，形成各种关系。四大水口：乙丙交而趋戌，辛壬会而聚辰，丁庚纳斗牛气，金羊收癸甲之灵。此是地理五诀三合风水的立，刻上各家风水的内容，就成为罗盘。罗盘虽是二十四方位，实质也是地球绕太阳一周的记录，反映的是一年的气候变化过程。周而复始，与地球绕太庚丁黑色字。创造者用意何苦？你了解了多少？六十甲子十天干十二地支组合的最小公倍数=60，为六十甲子。其派生：（1）六甲空亡。（2）纳音。上.中.下三元，称上元中元下元三元甲子(3x60=180年)。180为大元，每二十年为一运，共九运，统称三元九运。利用1至9数配上洛书九宫，阳顺飞.阴吉凶。这两门学术最显著的特点就是旺衰吉凶随时间的改变而改变。现代人利用它的理论来调整空间，摆放风水物，改门向达到趋吉避凶。（4）四柱合婚。风水基础知识理气法论断阳宅，以建筑里面的格局、陈列、摆饰为基准，对人的影响。论断阴宅，则以墓碑为主、墓穴为辅，用来论断阳间后代之[生、克、制、化]，及八卦、九宫、十天干、十二地支的演生变化，来断吉凶。峦头法论断建筑物外面的大环境，对人的影响。以龙、穴、砂、水的最崇拜的龙来形容，并赋予生命。穴指的是什么就是建物。含阴宅、墓穴与阳宅、房、舍观看山脉走向、起伏、推断[气]所凝聚胎息的位置，就是穴位于龙脉的大小。砂指的是什么指的是穴前后左右的四兽山、丘。即俗称的左青龙、右白虎、后玄武、前朱雀。炫舞指的是后方略高的小山，做为靠山;亦名案山。水指的是什么指的是河川、水池及道路。河川的水质及流速，会直接影响当地人的个性：水质清澈——流速绵延缓慢，居民性格温文，话语轻干涸——当地必有盗匪，黑道猖獗，百姓生活穷困。五行生克金.水.木.火.土（初学者按此顺序背诵，顺次相生，隔位相克)金生水.水生木.木生火.火生为：甲.丙.戊.庚.壬.阴干为：乙.丁.己.辛.癸3：天干的五行方位：.甲乙东方木.丙丁南方火.戊己中央土.庚辛西方金.壬癸北方水4:天干的合化：甲特性木曰：“曲直”。曲者，屈也；直者，伸也。故，木有能屈能伸之性。木纳水土之气，可生长发育。故木又具有生发、向上、修长、柔和、仁慈之性其势急，其性烈，其情恭。火主礼。土的特性土曰“稼穑”。播种为稼，收获为穑，土具有载物、生化、藏纳之能，故土载四行，为万物之母，具贡献、革、肃杀的特性。金主义。水的特性水日“润下”。润者，湿润也；下者，向下也。故水具有滋润、向下、淹藏的特性。水主智。河图口诀：一六共宗，南三八为朋，为木居东四九为友，为金居西五十同途，为土居中具体些就是一六这两个数字的河图五行属水二七这两个数字的河图五行属火三八这两个的环境，比如楼层，房屋间数等。洛书神话传说，古时洛水出现龟背上载有图形的神龟。大禹治水依据“洛书”，制定“九畴”来治理天下。洛书图，是远龟身的左侧和右侧为三和七，龟的二前腿为二和四，龟的二后腿为六和八，五在中央。洛书的八卦为后天八卦，离坎取乾坤为天地之用，火上升，水下上升，阴气下降。活火在地下为暖，雷为震则动，坎在地上聚焦、蒸发，离太阳普照。巽风、艮山上接于天下接于地，把天和自然现象连接在一起。故坤地纯阴，将天的阳气全收取，故地心纯热，成天地交泰，化生万物。洛书的奇数五在中央，北一、东三、西七、南九，偶数分占四角。由东北起八、理论之根据。河图；它所表示的数据是：一六居北方，为水；二七居南方，为火;三八居东方，为木;四九居西方，为金；五十居中央，为土;河图口诀朋，四九为友，五十同途。洛书；它所表示的数据是:戴九履一，左三右七，二四为肩，六八为足，五居中央。从洛书的数据来分析，它是由河图演化山，位置在西北，坐亥向巳坐乾向巽坐戌向辰的房子统称乾宅2：坎卦统领壬子癸三山，位置在正北，坐壬向丙坐子向午坐癸向丁的房子统称坎宅3：艮的房子统称震宅5：巽卦统领辰巽巳三山，位置在东南，坐辰向戌坐巽向乾坐巳向亥的房子统称巽宅6：离卦统领丙午丁三山，位置在正南，坐丙向壬坐统领未坤申三山，位置在西南，坐未向丑坐坤向艮坐申向寅的房子统称坤宅8：兑卦统领庚酉辛三山，位置在正西，坐庚向甲坐酉向卯坐心向乙的房子，右为北为坎。后天八卦后天八卦为文王所画。它来自于洛书。后天八卦是平放于地面由北向南看的，上离下坎，左震右兑。十干阴阳甲乙属木，甲为属水，壬为阳，癸为阴，位居北方地支阴阳子、寅、辰、午、申、戌为阳。丑、卯、巳、未、酉、亥为阴。1:子丑寅卯辰巳午未申酉戌亥（按顺序背诵种顺序：子午卯酉辰戌丑未寅申巳亥这种顺序直接可以记住地支六冲，以后许多推算也会用到这种顺序3:第三种顺序（三合局）：申子辰三合水局亥卯种顺序都要牢记，以后会经常用到。5:地支六冲：子午冲卯酉冲辰戌冲丑未冲寅申冲巳亥冲6：地支属相配：子鼠丑牛寅虎卯兔辰龙巳蛇午马未羊申猴九月戌十月亥十一月子十二月丑八卦阴阳乾、坎、艮、震为阳巽、离、坤、兑为阴八卦先天八卦数：乾一.兑二.离三.震四.翼五.坎六.艮七.坤八。后离九。九、二十四山及阴阳：二十四山由四维、八干、十二地支组成，罗盘上分别从坎山壬子癸、艮山丑艮寅、震山甲卯乙、巽山辰巽已、离山丙午丁——辰、戌、丑、未天元龙：阳——乾、坤、艮、巽，阴子、午、卯、酉人元龙：阳——寅、申、已、亥，阴：癸、丁、乙、辛风水学入门图解重点名词有哪〉。廖瑀《泄天机明堂入式歌》：明堂气聚始为奇，不聚即非宜。凡是穴前坦夷处，便是明堂位。....明堂光明照万方，宽阔始为良。”缪希《葬经翼处也。”徐善继《人子须知;水法》：“明堂欲其平正开畅，团聚朝抱。”又同书〈穴法〉：“若明堂不正不聚，倾泻倒侧，则是真气不融，纵有美穴，亦清朝丁芮朴《风水袪惑》：“风水之术，大抵不出形势、方位两家。言形势者，今谓之峦体，言方位者，今谓之理气。唐宋诗人，各有宗派授受。”《四人杨筠松，曾文辿及赖大有、谢子逸辈，尤精其学。其为说主形势，原其所起，即其所止，以定位向，专指龙穴砂水之相配，其它拘泥在所不论。今大理。与峦体之法并为堪舆术两大流派。开宗于福建，以秦汉“五姓图宅”五行生克论吉凶为权舆，至南未盛行于世。其法专主阴阳配合生剜制化，以罗盘周易》的原理以八卦，十二支，天星，五行为四大网，比峦体专论山川形势更为抽象。明清以后，术家倾向“峦头为体，理气为用”，两派渐渐合流。但之法，得水为上，藏风次之。”聚水指穴山前水聚成沼。堪舆家谓主生气厚蓄，易经天下公众号，为吉贵之象。徐善继《人子须知水法》：“穴前水最宜，聚则静矣，此其所以为贵。”缪希雍《葬经翼难解二十四篇》：“《经》云‘朱雀....泽于将衰’者，言将出必先汇泽，则有蓄聚也。”龙风水学中“龙”作‘龙’。”蔡元定《发微论》：“夫山以静为常，是唯无动，动则成动矣。成龙之山，必踊跃翔舞，若其偃硬?勒，则不融结者也。”砂又名“砂头”。堪舆....前朝、后乐、左龙、右虎、罗城、侍卫、水口诸山，与夫官、鬼、禽、曜，皆谓之砂。”廖瑀《泄天机;消砂入式歌》：“真龙落处四山聚，亦自有、曾教人原有格，五、九只从砂上拨，因兹名作《拨砂经》。”砂随位置、形状而有各种称呼；宋．张子微着的《玉髓真经》、明．徐善继、徐善述着”、“乐山”；在穴左，为“龙”；在穴右为“虎”；龙、虎上又生砂，明见者为“官星”（多在穴前），不见者为“曜星”：在穴后行龙身上者为“护”、“从”；“插耳”（太乙、天乙）。穴即“龙穴”。堪舆家所认为的土中气?聚结处。或成洼状，或成突状。谓“穴”生气最旺，适合安坟立宅。缪希雍《葬经翼;察形交阴阳融凝，情之所钟处也。”易经天下公众号，同书《怪穴篇》：“穴以藏聚为主。盖藏聚则精气翕集，暖而无风，暖则无水，无风则无蚁，三害不侵容。堪舆家认为，水为气之母，?气靠水运送而行，而水拦截而止，寻龙点穴，要根据水流的有无、大小、方向、形态等作出判断和印证。水势以深聚《发微论》：“两水之中必有山，故水会即龙尽，水交则龙止，水飞走则生气尽，水融注则内气聚。”徐善继《人子须知;水法》：“水深处民多富，水浅水散处民多离。”“水送则龙行，水界则龙止”，这个观念在没有明显高低落差的平原（平阳、平洋）地区，用于寻龙点穴是很重要的。有经验的地师可不杂）？向堪语术语。指宅或墓的坐向，与龙、砂、穴、水并为相地术五大要项。术家认为，坐向大要以背山面水，易经天下公众号，坐北朝南，避凶依实际地形裁夺，如到山到向虽吉，而坐山无山，向首无水，或坐山有水，向首有山，仍不宜选用。由于自然山水往往不免?差人意，术家每采取变通向以山为准，依水而变，用地盘测量，山龙若从子方来，午方有水，即用子山午向，是为最理想的风水宝地。但如水不在午方而在丙方，则改用壬山丙曰龙，龙要真；二曰穴，穴要的；三曰砂，砂要秀；四曰水，水要抱；五曰向，向要吉。”旧题南唐何溥《灵城精义》卷下：“龙以?为主，穴以向为尊无他门。若坐穴立向，则虽内以首，水自寅艮来，由戌干去，若以双山五行属木，则冲破胎养，以正行属水，则冲破冠带，俱不合度，当立丙丁向，则火，其穴在戌，用可收艮之水而发福。此以玄空五行收向上之水也。水有息道漏道，从入而成，至山向而折之，乃漏道，则生成之局非人为也。故古人向。盖山水已结，未有不可用者，或水有不合，当于向上转移而消之。自古立向消水有许多法度，非以滋后人之惑，只是今人有个法度，以合山川之性的祖坟，本人就是在一次看地图时偶然发现，原来就在自己居住地附近）。杨筠松是用“望气法”来看，《撼龙经》说：“寻龙望气先寻?，云雾多生是龙生处觅；云霓先生绝高顶，此是龙楼宝殿定，大脊微微云自生，雾气如多反难证。先寻雾气识正龙，?望枝龙观远应，因就正龙行?处，认取破禄中间行从卫星照片、空测图及各种地图，就可迅速查得。通常说的祖山包括：1）太祖山：龙之初发?，是一个大区域（全世界．全国）的最高峰；如世界最高近觑巉岩，可畏。据镇一方，乃群龙之所从出，易经天下公众号，大则为邦国都郡，小则为县邑。山体端严方正，则一方所产之人，多贤能俊秀；偏斜。2）少祖山：是太祖山发?之后，再冲起的高山，又称为“应星”；其形状与太祖山不同，或尖、或圆、或方，精神充满，形象秀丽。风水家以此山定龙。大祖为祖山，少祖为宗山。3）列祖山：“列祖”是总举先人的称谓，少祖山发?之后再起高峰，三三两两、五五六六，这些中间相间的山峰都叫做列祖的主山叫父母山，又叫“玄武脑”、“盖山”、“照山”、“太阳山”。廖璃说：“若是山家结穴龙，定起主星峰。”此山以星举开面．?穿心者为上，旁出者次太祖山分别龙的贵*，从少祖山分别龙的善恶，从列祖山分别龙的去向，从父母山分别龙的作用。一般人最喜坐后靠着山峰。但杨筠松的《都天宝照经“旺山旺向”之局。平洋大都后空，以坐空为正局。中国风水的起源殷商时期到了殷周时期，已经开始了有文字记载的相地活动。如殷墟出土的甲骨文中规模的宫室营建为风水术的形成造成了物质前提。董仲舒的阴阳五行学说和孟喜、京房等人的易学理论为风水以及一切术数提供了理论与方法。特别是忌与迷信越发盛行，如“起宅盖房必择日”，“太岁头上不能动土”已成为阳宅建筑中应遵循的重要规则。此时，阴宅风水理论也在渐渐形成。例如韩信年，葬地的山形如川字，法当战死。仲翔不信，汉初果战于狄道而死。与风水活动频繁的同时，秦汉时期还出现了一批有关风水的专著，如《堪舆金匮》可以称为风水学了。隋唐：传播时期隋唐时期，隋宰相杨恭仁准备仁祖辈的葬地，请了海内有名的相地家卜地，这些人各有一套，杨恭仁不知听谁的好角的土各一斗，并在历书上写着地的形势。相地家们都没说准。有个叫舒绰的说：“此土五尺外有五谷，得其一即是福地，世为公侯。”杨恭仁请舒绰到分化，风水术侧重于看坟地，迷信色彩十分严重。据《通典》卷138引《开元礼》记载，唐代不论是官人还是庶人，只要死了，都要择地择日下葬，这水的皇帝。他原先没有儿子，有个叫刘混康的术士告诉他，京师西北隅地势过低，如培筑增高，当得多男之喜。徽宗就命令大兴土木，叠起冈阜，高约更加相信风水术了，改筑延福宫，又命灵素择地，修建上清宝篆宫。在宋朝，葬地的好坏，被认为与吉凶有关。宋人认为旧坟地不宜葬。钱希白《小说炳不从，掘地发现数重石板，石中飞出一枚黑蜂对着文炳的右眉一螫，文炳头肿如斗，当晚身亡。宋代真正到达风水术盛行的时代，宋徽宗就是一个很阜，易经天下公众号，高约数仍，后来果然得了儿子。徽宗就更加相信风水术了，改筑延福宫，又命灵素择地，修建上清宝篆宫，劳民伤财，导致国库宋朝，葬地的好坏，被认为与吉凶有关。宋人认为旧坟地不宜葬。钱希白《小说》记载宋初，钱文炳的妻子死了，炳从小精于相地术，就在报恩院侧的文炳头肿如斗，当晚身亡。但风水宝地不是人人都可享受的，土地各有其主。《夷志坚》叙述陈魏公父墓说，福建莆田有一块富民的葬地，富民葬此处上了宰相，风水师说这是地得其主。明清：鼎盛时期但到了明清时代，风水术进入鼎盛时期。明太祖朱元璋建都金陵(南京)，为都城的风水花了不少精内，有朝拱之意。只是牛首山和太平门外的花山，背对城垣，独无拱卫之意，朱元璋为此怅然不乐。传说他命刑部带着刑具，将牛首山痛打一百棍，又的过程中，始终是按照风水观念进行的。如天坛圆丘西北有座坐西朝东的斋宫，其朝向很特别，与传统的坐北朝南不一样。这是因为，当时的人认为，，以示区别。清王朝对阳宅建筑也是很讲究的。如颐和园的排云殿就是风水极佳之处。排云殿的位置处于从佛香阁至“云辉玉宇”牌楼中轴线的中间，有祥之意。殿中大厦上写着“蕃厘经纬”“永固鸿基”。殿名是根据风水术祖师郭璞的诗“神仙排云出，但见金银台”中的“排云”二字命名。排云殿傍山依水，士人为重。《儒林外史》记载，范进的母亲死后，范进请阴阳先生写七单。当时的阴阳先生是专替丧家推算殓葬日辰，看风水，相地脉，替人家选择吉搁在家里不葬。终日打听风水宝地，以图得到吉祥的后果。"""
#
#     print("=== 简单分割 ===")
#     simple_chunks = splitter.split_text(text, chunk_size=1024, chunk_overlap=100, recursive=False)
#     for i, chunk in enumerate(simple_chunks):
#         print(f"块 {i + 1} (长度: {len(chunk)}): {chunk}...")
#
#     print("\n=== 递归分割 ===")
#     recursive_chunks = splitter.split_text(text, chunk_size=200, chunk_overlap=50, recursive=True)
#     for i, chunk in enumerate(recursive_chunks):
#         print(f"块 {i + 1} (长度: {len(chunk)}): {chunk}...")



